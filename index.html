<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <!-- Evita lo zoom automatico in Safari iOS quando si focussano i campi (per richiesta esplicita) -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Verifica la tua reputazione</title>
  <!-- Favicon emoji üîç come SVG inline -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.9em" font-size="90">üîç</text></svg>' />
  <style>
    :root{ --bg:#0b132b; --soft:#1c2541; --ink:#e0e6f0; --muted:#9fb3c8; --accent:#3a86ff; --good:#38b000; --warn:#ffb703; --bad:#ef233c; --field:#0f1b3d; }
    /* Base */
    html,body{ height:100%; }
    body{ margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; -webkit-font-smoothing:antialiased; }
    .wrap{ max-width:900px; margin:0 auto; padding: clamp(16px, 2.5vw, 28px); }
    .card{ background:var(--soft); border-radius:16px; padding: clamp(16px, 2.5vw, 24px); box-shadow:0 12px 28px rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.05); }

    /* Titoli e testo */
    h1{ margin:6px 0 12px; font-size:clamp(1.3rem, 2.2vw, 1.8rem); display:flex; align-items:center; gap:8px; }
    p{ color:var(--muted); line-height:1.6; }

    /* Form dentro la cornice (app frame) */
    .form-shell{ background: rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.06); border-radius:14px; padding:16px; margin-top:8px; }
    label{ display:block; margin:.55rem 0 .35rem; color:var(--ink); font-weight:600; }
    input[type="text"], input[type="password"], input[type="search"], select{
      width:100%; padding:14px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.10); background:var(--field); color:var(--ink);
      outline:none; font-size:16px; /* >=16px per evitare zoom iOS */
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
    }
    input::placeholder{ color:#a9b8d6; }
    select{ appearance:none; -webkit-appearance:none; background-image: linear-gradient(45deg, transparent 50%, #b8d1ff 50%), linear-gradient(135deg, #b8d1ff 50%, transparent 50%);
            background-position: calc(100% - 18px) 50%, calc(100% - 12px) 50%; background-size:6px 6px, 6px 6px; background-repeat:no-repeat; }

    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .row > div{ flex:1 1 240px; }

    .btn{ background:var(--accent); color:white; border:none; padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:800; letter-spacing:.2px; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; gap:8px; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .btn.secondary{ background:transparent; border:1px solid rgba(255,255,255,.15); color:#b8d1ff; }

    .tiny{ font-size:.92rem; color:var(--muted); }
    .results{ margin-top:18px; }
    .pill{ display:inline-block; padding:4px 10px; border-radius:999px; font-size:.75rem; font-weight:700; }
    .neg{ background:rgba(239,35,60,.18); color:#ffdada; border:1px solid rgba(239,35,60,.4); }
    .pos{ background:rgba(56,176,0,.18); color:#daf5d8; border:1px solid rgba(56,176,0,.4); }
    .neu{ background:rgba(255,183,3,.18); color:#fff0cc; border:1px solid rgba(255,183,3,.45); }
    .score{ font-weight:900; }
    .item{ padding:14px; border-radius:12px; background:#101b38; border:1px solid rgba(255,255,255,.06); margin:10px 0; }
    .item a{ color:#b8d1ff; text-decoration:underline; }
    mark{ background:rgba(239,35,60,.5); color:white; padding:0 .2em; border-radius:4px; }
    .footer{ margin-top:16px; font-size:.95rem; color:var(--muted); }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:760px){
      .grid-2{ grid-template-columns:1fr; }
      .btn.full{ width:100%; }
    }
    .sep{ height:1px; background:rgba(255,255,255,.06); margin:16px 0; }

    /* Accessibilit√† & iOS niceties */
    :focus-visible{ outline:2px solid #b8d1ff; outline-offset:2px; border-radius:10px; }
    @supports (-webkit-touch-callout: none){ input, select{ font-size:16px; } }
    
    /* Safe areas per iPhone (evita tagli nelle aree curve) */
    .wrap{ padding-left: max(16px, env(safe-area-inset-left)); padding-right:max(16px, env(safe-area-inset-right)); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üîç Verifica la tua reputazione</h1>
      <p>Inserisci <strong>Nome e Cognome</strong> oppure una <strong>Ragione Sociale</strong>. Il sistema cerca notizie pubbliche e segnala contenuti potenzialmente negativi (indagini, condanne, ecc.) o positivi (assoluzioni, archiviazioni).</p>

      <!-- FORM dentro la cornice dell'app -->
      <div class="form-shell" role="form" aria-label="Form ricerca reputazione">
        <div class="row">
          <div>
            <label for="query">Nome / Azienda</label>
            <input id="query" type="search" inputmode="search" autocomplete="name" placeholder='Es. "Mario Rossi" oppure "Rossi Srl"' />
          </div>
          <div>
            <label for="location">Localit√† (opzionale)</label>
            <input id="location" type="text" inputmode="text" autocomplete="address-level2" placeholder='Es. "Milano", "Roma"' />
          </div>
        </div>

        <div class="row" style="margin-top:8px; align-items:flex-end;">
          <div>
            <label for="dateWindow">Finestra temporale</label>
            <select id="dateWindow">
              <option value="y1">Ultimo anno</option>
              <option value="m6">Ultimi 6 mesi</option>
              <option value="y2">Ultimi 2 anni</option>
              <option value="" selected>Tutti i periodi</option>
            </select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="run" class="btn full">Verifica la mia reputazione</button>
          </div>
        </div>
      </div>

      <p class="tiny">‚ö†Ô∏è Uso responsabile: i risultati sono indicativi e potrebbero contenere omonimie. Per una valutazione legale e un‚Äôeventuale rimozione, puoi richiedere una consulenza dedicata.</p>

      <div id="out" class="results"></div>

      <div class="footer">
        <div class="sep"></div>
        <p>
          Vuoi sapere se questi contenuti si possono rimuovere?
          <a class="btn secondary" href="https://levalink.com/" target="_blank" rel="noopener noreferrer">Richiedi una consulenza gratuita</a>
        </p>
      </div>
    </div>
  </div>

<script>
  // =========================
  // VOCABOLARI
  // =========================
  const NEGATIVE_TERMS = [
    "indagato","indagine","indagini","arresto","arrestato","truffa","truffatore","frode","condanna","condannato",
    "procedimento penale","misura cautelare","avviso di garanzia","rinvio a giudizio","calunnia","diffamazione",
    "bancarotta","estorsione","corruzione","riciclaggio","associazione a delinquere","sequestro",
    "revoca licenza","sanzione","procedura disciplinare","blacklist","scandalo","inchiesta"
  ];
  const POSITIVE_TERMS = [
    "assolto","assolta","assoluzione","assolto con formula piena",
    "prosciolto","prosciolta","proscioglimento",
    "archiviazione","archiviato","archiviata",
    "non luogo a procedere","nlap",
    "riabilitazione","revoca misura","annullato","annullata","prescrizione"
  ];

  // Evidenzia parole chiave
  function highlight(text, terms){
    if(!text) return "";
    let safe = text.replace(/</g,"&lt;").replace(/>/g,"&gt;");
    terms.forEach(t=>{
      const re = new RegExp(`\\b(${escapeRegExp(t)})\\b`,"gi");
      safe = safe.replace(re, "<mark>$1</mark>");
    });
    return safe;
  }
  const escapeRegExp = (s)=> s.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\$&');

  // Classificazione (priorit√† al positivo)
  function classify(text){
    const t = (text||"").toLowerCase();
    const hasPos = POSITIVE_TERMS.some(w => t.includes(w.toLowerCase()));
    if (hasPos) return "positivo";
    const hasNeg = NEGATIVE_TERMS.some(w => t.includes(w.toLowerCase()));
    if (hasNeg) return "negativo";
    return "neutro";
  }

  // Punteggio complessivo
  function scoreSummary(items){
    let pos=0, neg=0, neu=0;
    items.forEach(it=>{
      if (it._class === "positivo") pos++;
      else if (it._class === "negativo") neg++;
      else neu++;
    });
    let score = Math.max(0, Math.min(100, 100 - (neg*20) + (pos*10)));
    return {pos,neg,neu,score};
  }

  // =========================
  // RICERCA (via Netlify Function)
  // =========================
  async function searchWeb(query, dateRestrict){
    const params = new URLSearchParams({ q: query });
    if (dateRestrict) params.set("dateRestrict", dateRestrict);
    const res = await fetch(`/.netlify/functions/search?` + params.toString());
    if (!res.ok) throw new Error("Errore chiamata funzione server");
    const data = await res.json();
    return data.items || [];
  }

  // =========================
  // UI HANDLERS
  // =========================
  const runBtn = document.getElementById("run");
  const out = document.getElementById("out");

  runBtn.addEventListener("click", async ()=>{
    const name = document.getElementById("query").value.trim();
    const loc = document.getElementById("location").value.trim();
    const dateWindow = document.getElementById("dateWindow").value;

    if (!name){ alert("Inserisci un nome o un'azienda"); return; }

    const qParts = [`"${name}"`];
    if (loc) qParts.push(loc);
    qParts.push("(assolto OR prosciolto OR archiviazione OR indagato OR indagine OR condannato OR processo)");
    const q = qParts.join(" ");

    runBtn.disabled = true; runBtn.textContent = "Analizzo...";
    out.innerHTML = "";

    try{
      const rows = await searchWeb(q, dateWindow); // dateWindow usa gi√† valori compatibili (m6,y1,y2)
      rows.forEach(r => r._class = classify(`${r.title||""} ${r.snippet||""}`));
      const summary = scoreSummary(rows);
      renderSummary(summary);
      renderList(rows);
      renderCTA(summary);
    }catch(e){
      out.innerHTML = `<p class="tiny">‚ùå ${e.message}. Verifica la funzione Netlify e le variabili d'ambiente.</p>`;
    }finally{
      runBtn.disabled = false; runBtn.textContent = "Verifica la mia reputazione";
    }
  });

  function renderSummary({pos,neg,neu,score}){
    const color = score>=80? "good" : score>=60? "warn" : "bad";
    out.insertAdjacentHTML("beforeend", `
      <div class="item">
        <div><span class="pill pos">Positivi: ${pos}</span> &nbsp;
             <span class="pill neg">Negativi: ${neg}</span> &nbsp;
             <span class="pill neu">Neutri: ${neu}</span></div>
        <p style="margin:.6rem 0 0;">Indice reputazionale: <span class="score" style="color:var(--${color});">${score}/100</span></p>
      </div>
    `);
  }

  function renderList(items){
    if (!items.length){
      out.insertAdjacentHTML("beforeend", `<p class="tiny">Nessun risultato trovato per i criteri selezionati.</p>`);
      return;
    }
    items.forEach(it=>{
      const tag = it._class==="negativo" ? `<span class="pill neg">Negativo</span>`
               : it._class==="positivo" ? `<span class="pill pos">Positivo</span>`
               : `<span class="pill neu">Neutro</span>`;
      const hTitle = highlight(it.title, [...NEGATIVE_TERMS, ...POSITIVE_TERMS]);
      const hSnip  = highlight(it.snippet, [...NEGATIVE_TERMS, ...POSITIVE_TERMS]);
      out.insertAdjacentHTML("beforeend", `
        <div class="item">
          <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
            <a href="${it.link}" target="_blank" rel="noopener noreferrer">${hTitle}</a>
            ${tag}
          </div>
          <p class="tiny" style="margin:.4rem 0 0;">${hSnip}</p>
        </div>
      `);
    });
  }

  function renderCTA(summary){
    let msg = "Hai risultati negativi: possiamo valutare rimozione, deindicizzazione o aggiornamento.";
    if (summary.neg===0 && summary.pos>0) msg = "Ottimo: emergono esiti positivi (assoluzioni/archiviazioni). Possiamo aiutarti a farli prevalere e rimuovere vecchi contenuti.";
    out.insertAdjacentHTML("beforeend", `
      <div class="item">
        <p>${msg}</p>
        <a class="btn" href="https://levalink.com/" target="_blank" rel="noopener noreferrer">Richiedi una valutazione gratuita</a>
      </div>
    `);
  }
</script>
</body>
</html>